version: 0.2

env:
  variables:
    REPOSITORY_URI: "537124967315.dkr.ecr.us-east-1.amazonaws.com/flightregistry"
    IMAGE_TAG: "latest"

phases:
  install:
    runtime-versions:
      docker: 19
      java: openjdk11
    commands:
      - echo "Installing Gradle..."
      - curl -s https://get.sdkman.io | bash
      - source "$HOME/.sdkman/bin/sdkman-init.sh"
      - sdk install gradle 7.3 # You can adjust the version as needed
      - gradle --version

  pre_build:
    commands:
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REPOSITORY_URI

  build:
    commands:
      - echo "Building the Spring Boot application..."
      - ./gradlew build -x test # Skipping tests for faster builds; you can modify this if needed
      - echo "Building the Docker image..."
      - docker build -t $REPOSITORY_URI:$IMAGE_TAG .
      - echo "Tagging the Docker image..."
      - docker tag $REPOSITORY_URI:$IMAGE_TAG $REPOSITORY_URI:$IMAGE_TAG

  post_build:
    commands:
      - echo "Pushing the Docker image to ECR..."
      - docker push $REPOSITORY_URI:$IMAGE_TAG

artifacts:
  files:
    - Dockerfile
    - build/libs/*.jar # Include your JAR file in case you want to use it later
